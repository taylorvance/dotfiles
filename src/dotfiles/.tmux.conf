# ==============================================================================
# TMUX CONFIG
# ==============================================================================
#
# Prefix: C-Space
#
# SPLITS     |  -  \(no shift)
# PANES      hjkl (nav)  HJKL (resize)  Space (zoom)  x (kill)  Tab (cycle)
# WINDOWS    c (new)  1-9 (switch)  C-h/C-l (prev/next)  P/N (move)  r (rename)
# SESSIONS   s (picker)  f (fzf)  C-n (new)  R (rename)  d (detach)
# POPUPS     ` (terminal)  g (lazygit)  t (htop)
# COPY       v (enter)  v/V/C-v (select)  y (yank)  / ? (search)  Esc (exit)
# OTHER      a (sync panes)  C-r (reload)  e (edit config)  b (toggle bar)
# PLUGINS    I (install)  U (update)
#
# ==============================================================================

# -----------------------------------------------------------------------------
# GENERAL SETTINGS
# -----------------------------------------------------------------------------

# Prefix: C-Space (no conflicts, ergonomic)
unbind C-b
set -g prefix C-Space
bind C-Space send-prefix

# CRITICAL: Remove escape delay (makes vim responsive)
set -sg escape-time 0

# Increase repeat timeout for repeated commands
set -g repeat-time 600

# Enable true color and fix terminal
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc,alacritty:Tc"

# Enable focus events (for vim autoread, etc.)
set -g focus-events on

# Massive scrollback
set -g history-limit 100000

# Start numbering at 1 (matches keyboard layout)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Don't auto-rename windows
set -g allow-rename off

# Aggressive resize (useful for grouped sessions)
setw -g aggressive-resize on

# Display messages longer
set -g display-time 2000
set -g display-panes-time 2000

# Refresh status more often
set -g status-interval 5

# -----------------------------------------------------------------------------
# MOUSE
# -----------------------------------------------------------------------------

set -g mouse on

# Middle click to paste from primary selection
bind -n MouseDown2Pane run "tmux set-buffer \"$(xclip -o 2>/dev/null || pbpaste)\"; tmux paste-buffer"

# -----------------------------------------------------------------------------
# WINDOW & PANE MANAGEMENT
# -----------------------------------------------------------------------------

# Split panes with | and - (intuitive), open in current path
bind | split-window -h -c "#{pane_current_path}"
bind \\ split-window -h -c "#{pane_current_path}"  # No shift needed
bind - split-window -v -c "#{pane_current_path}"
bind _ split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# New window in current directory
bind c new-window -c "#{pane_current_path}"

# Vim-like pane navigation
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

# Vim-like pane resizing (repeatable)
bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

# Window navigation
bind -r C-h previous-window
bind -r C-l next-window

# Quick pane cycling
bind Tab select-pane -t :.+
bind BTab select-pane -t :.-

# Swap panes
bind > swap-pane -D
bind < swap-pane -U

# Move windows left/right
bind -r P swap-window -t -1\; select-window -t -1
bind -r N swap-window -t +1\; select-window -t +1

# Break pane into new window / join pane from another window
bind B break-pane
bind M choose-window "join-pane -h -s '%%'"

# Toggle zoom (already default, but making it memorable)
bind z resize-pane -Z
bind Space resize-pane -Z  # Space to zoom is nice

# Kill pane/window without confirmation
bind x kill-pane
bind X kill-window

# -----------------------------------------------------------------------------
# SESSION MANAGEMENT
# -----------------------------------------------------------------------------

# Session switcher
bind s choose-tree -Zs
bind S choose-tree -Z

# Quick session switching with fzf (if available)
bind f display-popup -E "tmux list-sessions -F '#{session_name}' | fzf --reverse | xargs -I{} tmux switch-client -t {}"

# New session
bind C-n new-session

# Rename session/window
bind r command-prompt -I "#W" "rename-window '%%'"
bind R command-prompt -I "#S" "rename-session '%%'"

# Detach
bind d detach-client
bind D if -F '#{session_many_attached}' \
    'confirm-before -p "Detach other clients? (y/n)" "detach -a"' \
    'display "Session has only 1 client attached"'

# -----------------------------------------------------------------------------
# COPY MODE (VI STYLE)
# -----------------------------------------------------------------------------

setw -g mode-keys vi

# Enter copy mode
bind v copy-mode
bind -n M-v copy-mode  # Alt-v without prefix

# Setup vi-style copy
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi C-v send -X rectangle-toggle
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Enter send -X copy-pipe-and-cancel "pbcopy"
bind -T copy-mode-vi Escape send -X cancel

# Incremental search (like vim)
bind -T copy-mode-vi / command-prompt -i -p "search down" "send -X search-forward-incremental '%%%'"
bind -T copy-mode-vi ? command-prompt -i -p "search up" "send -X search-backward-incremental '%%%'"

# Quick scroll
bind -T copy-mode-vi C-u send -X halfpage-up
bind -T copy-mode-vi C-d send -X halfpage-down

# -----------------------------------------------------------------------------
# POPUP WINDOWS (tmux 3.2+)
# -----------------------------------------------------------------------------

# Popup terminal (great for quick commands)
bind ` display-popup -E -w 80% -h 80%
bind C-t display-popup -E -w 80% -h 80%

# Popup lazygit (if installed)
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "lazygit || git status"

# Popup for quick notes
bind n display-popup -E -w 60% -h 60% "nvim ~/notes/scratch.md"

# Popup htop/btop
bind t display-popup -E -w 90% -h 90% "btop || htop || top"

# -----------------------------------------------------------------------------
# STATUS BAR
# -----------------------------------------------------------------------------

set -g status-position top
set -g status-style "bg=default,fg=colour248"

# Left: session name
set -g status-left-length 50
set -g status-left "#[fg=colour39,bold]  #S #[fg=colour240]â”‚ "

# Right: date/time
set -g status-right-length 50
set -g status-right "#[fg=colour240]â”‚ #[fg=colour248]%a %b %d #[fg=colour39]%H:%M "

# Center: windows
set -g status-justify centre

# Window status
setw -g window-status-format "#[fg=colour245] #I:#W "
setw -g window-status-current-format "#[fg=colour39,bold] #I:#W* "
setw -g window-status-separator ""

# Activity
setw -g monitor-activity on
set -g visual-activity off
setw -g window-status-activity-style "fg=colour214"

# Pane borders
set -g pane-border-style "fg=colour240"
set -g pane-active-border-style "fg=colour39"

# Messages
set -g message-style "bg=colour235,fg=colour39"
set -g message-command-style "bg=colour235,fg=colour39"

# Mode (copy mode, etc.)
setw -g mode-style "bg=colour39,fg=colour235"

# -----------------------------------------------------------------------------
# QUICK ACTIONS
# -----------------------------------------------------------------------------

# Reload config
bind C-r source-file ~/.tmux.conf \; display "Config reloaded!"

# Edit config
bind e new-window -n "tmux.conf" "nvim ~/.tmux.conf && tmux source ~/.tmux.conf && tmux display 'Config reloaded!'"

# Clear screen and history
bind C-k send-keys C-l \; run 'sleep 0.1' \; clear-history

# Synchronize panes toggle (type in all panes at once)
bind a setw synchronize-panes \; display "Sync: #{?synchronize-panes,ON,OFF}"

# Toggle status bar
bind b set status

# -----------------------------------------------------------------------------
# LAYOUTS
# -----------------------------------------------------------------------------

# Quick layouts
bind M-1 select-layout even-horizontal
bind M-2 select-layout even-vertical
bind M-3 select-layout main-horizontal
bind M-4 select-layout main-vertical
bind M-5 select-layout tiled

# -----------------------------------------------------------------------------
# PLUGINS (via TPM)
# -----------------------------------------------------------------------------

# Plugin manager
set -g @plugin 'tmux-plugins/tpm'

# Sensible defaults
set -g @plugin 'tmux-plugins/tmux-sensible'

# Session persistence (GAME CHANGER - survives reboots)
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @resurrect-capture-pane-contents 'on'
set -g @resurrect-strategy-nvim 'session'  # Restore nvim sessions
set -g @continuum-restore 'on'              # Auto-restore on tmux start
set -g @continuum-save-interval '10'        # Save every 10 minutes

# Better copy/paste
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank-selection 'clipboard'

# Open URLs and files from terminal
set -g @plugin 'tmux-plugins/tmux-open'

# Seamless vim/tmux navigation (if using vim-tmux-navigator in nvim)
# set -g @plugin 'christoomey/vim-tmux-navigator'

# -----------------------------------------------------------------------------
# INITIALIZE TPM (keep at bottom)
# -----------------------------------------------------------------------------

# Auto-install TPM if not present
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize plugin manager
run '~/.tmux/plugins/tpm/tpm'
