#!/bin/sh
# System information utility - quick hardware specs at a glance

set -e

show_help() {
	cat <<EOF
Usage: sysinfo [OPTIONS]

Cross-platform system information utility that displays hardware specs.

OPTIONS:
    -h, --help               Show this help message

SUPPORTED PLATFORMS:
    macOS (Intel and Apple Silicon), Linux, WSL
EOF
}

# Detect platform
detect_platform() {
	if [ "$(uname)" = "Darwin" ]; then
		echo "macos"
	elif [ -f /proc/version ] && grep -qi microsoft /proc/version; then
		echo "wsl"
	elif [ "$(uname)" = "Linux" ]; then
		echo "linux"
	else
		echo "unknown"
	fi
}

# Get CPU info
get_cpu() {
	local platform="$1"
	case "$platform" in
		macos)
			local brand=$(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo "Unknown")
			local cores=$(sysctl -n hw.ncpu 2>/dev/null || echo "?")
			echo "$brand ($cores cores)"
			;;
		linux|wsl)
			local model=$(grep -m1 "model name" /proc/cpuinfo 2>/dev/null | cut -d: -f2 | sed 's/^[[:space:]]*//' || echo "Unknown")
			local cores=$(grep -c "^processor" /proc/cpuinfo 2>/dev/null || echo "?")
			echo "$model ($cores cores)"
			;;
		*)
			echo "Unknown"
			;;
	esac
}

# Get RAM in GB
get_ram() {
	local platform="$1"
	case "$platform" in
		macos)
			local bytes=$(sysctl -n hw.memsize 2>/dev/null || echo "0")
			echo "$(echo "scale=0; $bytes / 1024 / 1024 / 1024" | bc) GB"
			;;
		linux|wsl)
			local kb=$(grep MemTotal /proc/meminfo 2>/dev/null | awk '{print $2}' || echo "0")
			echo "$(echo "scale=0; $kb / 1024 / 1024" | bc) GB"
			;;
		*)
			echo "Unknown"
			;;
	esac
}

# Get GPU info
get_gpu() {
	local platform="$1"
	case "$platform" in
		macos)
			local chip=$(system_profiler SPDisplaysDataType 2>/dev/null | grep "Chipset Model:" | head -1 | cut -d: -f2 | sed 's/^[[:space:]]*//')
			local vram=$(system_profiler SPDisplaysDataType 2>/dev/null | grep "VRAM" | head -1 | cut -d: -f2 | sed 's/^[[:space:]]*//')
			local metal=$(system_profiler SPDisplaysDataType 2>/dev/null | grep -o "Metal.*" | head -1)
			if [ -n "$chip" ]; then
				local result="$chip"
				[ -n "$vram" ] && result="$result ($vram)"
				[ -n "$metal" ] && [ -z "$vram" ] && result="$result ($metal)"
				echo "$result"
			else
				echo "Unknown"
			fi
			;;
		linux|wsl)
			if command -v lspci >/dev/null 2>&1; then
				lspci 2>/dev/null | grep -i "vga\|3d\|display" | head -1 | sed 's/.*: //' || echo "Unknown"
			else
				echo "Unknown (lspci not available)"
			fi
			;;
		*)
			echo "Unknown"
			;;
	esac
}

# Get storage info (used / total)
get_storage() {
	local platform="$1"
	local path="/"
	# macOS APFS: user data lives on /System/Volumes/Data
	[ "$platform" = "macos" ] && [ -d "/System/Volumes/Data" ] && path="/System/Volumes/Data"
	local used=$(df -h "$path" 2>/dev/null | tail -1 | awk '{print $3}')
	local total=$(df -h "$path" 2>/dev/null | tail -1 | awk '{print $2}')
	local pct=$(df -h "$path" 2>/dev/null | tail -1 | awk '{print $5}')
	if [ -n "$used" ] && [ -n "$total" ]; then
		echo "${used}B / ${total}B ($pct)"
	else
		echo "Unknown"
	fi
}

# Get display resolution
get_display() {
	local platform="$1"
	case "$platform" in
		macos)
			system_profiler SPDisplaysDataType 2>/dev/null | grep "Resolution:" | head -1 | cut -d: -f2 | sed 's/^[[:space:]]*//' || echo "Unknown"
			;;
		linux)
			if command -v xrandr >/dev/null 2>&1 && [ -n "$DISPLAY" ]; then
				xrandr 2>/dev/null | grep '\*' | head -1 | awk '{print $1}' || echo "Unknown"
			else
				echo "Unknown (no display or xrandr)"
			fi
			;;
		wsl)
			echo "N/A (WSL)"
			;;
		*)
			echo "Unknown"
			;;
	esac
}

# Get OS info
get_os() {
	local platform="$1"
	case "$platform" in
		macos)
			local ver=$(sw_vers -productVersion 2>/dev/null || echo "Unknown")
			local build=$(sw_vers -buildVersion 2>/dev/null)
			[ -n "$build" ] && echo "macOS $ver ($build)" || echo "macOS $ver"
			;;
		linux)
			if [ -f /etc/os-release ]; then
				. /etc/os-release
				echo "${PRETTY_NAME:-Linux}"
			else
				echo "Linux $(uname -r)"
			fi
			;;
		wsl)
			if [ -f /etc/os-release ]; then
				. /etc/os-release
				echo "${PRETTY_NAME:-Linux} (WSL)"
			else
				echo "Linux (WSL)"
			fi
			;;
		*)
			echo "Unknown"
			;;
	esac
}

# Get architecture
get_arch() {
	uname -m
}

# Get hostname
get_hostname() {
	hostname 2>/dev/null || cat /etc/hostname 2>/dev/null || echo "Unknown"
}

# Get username
get_username() {
	whoami 2>/dev/null || echo "${USER:-Unknown}"
}

# Get local IP
get_local_ip() {
	local platform="$1"
	case "$platform" in
		macos)
			local ip=$(ipconfig getifaddr en0 2>/dev/null || ipconfig getifaddr en1 2>/dev/null)
			echo "${ip:-No active connection}"
			;;
		linux|wsl)
			local ip=$(ip route get 1 2>/dev/null | awk '{print $7; exit}')
			if [ -z "$ip" ]; then
				ip=$(hostname -I 2>/dev/null | awk '{print $1}')
			fi
			echo "${ip:-No active connection}"
			;;
		*)
			echo "Unknown"
			;;
	esac
}

# Get public IP
get_public_ip() {
	curl -s --max-time 2 ifconfig.me 2>/dev/null || \
	curl -s --max-time 2 icanhazip.com 2>/dev/null || \
	echo "Unavailable"
}

# Main
main() {
	while [ $# -gt 0 ]; do
		case "$1" in
			-h|--help)
				show_help
				exit 0
				;;
			*)
				echo "Unknown option: $1" >&2
				exit 1
				;;
		esac
	done

	local platform=$(detect_platform)

	echo ""
	printf "%-12s %s\n" "CPU:" "$(get_cpu "$platform")"
	printf "%-12s %s\n" "RAM:" "$(get_ram "$platform")"
	printf "%-12s %s\n" "GPU:" "$(get_gpu "$platform")"
	printf "%-12s %s\n" "Storage:" "$(get_storage "$platform")"
	printf "%-12s %s\n" "Display:" "$(get_display "$platform")"
	echo ""
	printf "%-12s %s\n" "OS:" "$(get_os "$platform")"
	printf "%-12s %s\n" "Arch:" "$(get_arch)"
	printf "%-12s %s\n" "Hostname:" "$(get_hostname)"
	printf "%-12s %s\n" "User:" "$(get_username)"
	echo ""
	printf "%-12s %s\n" "Local IP:" "$(get_local_ip "$platform")"
	printf "%-12s %s\n" "Public IP:" "$(get_public_ip)"
	echo ""
}

main "$@"
